<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="背景 公司的APP之前一直是放在公司服务器，没有发布到应用市场，每次发布新版本用户更新都很麻烦。前段时间抽时间写了个应用内下载APK并更新的模块。 整个模块主要的几个类:
UpgradeManager UpgradeService FileResponseBody ResponseInterceptor 网络请求使用的是Retrofit2+Rxjava2
"><title>Android应用内下载并更新APK</title><link rel=canonical href=https://zole.life/p/android%E5%BA%94%E7%94%A8%E5%86%85%E4%B8%8B%E8%BD%BD%E5%B9%B6%E6%9B%B4%E6%96%B0apk/><link rel=stylesheet href=/scss/style.min.ac77dcf8b111b51da39a92990f431923f210f3876d85798a2125667f96dc33a4.css><meta property="og:title" content="Android应用内下载并更新APK"><meta property="og:description" content="背景 公司的APP之前一直是放在公司服务器，没有发布到应用市场，每次发布新版本用户更新都很麻烦。前段时间抽时间写了个应用内下载APK并更新的模块。 整个模块主要的几个类:
UpgradeManager UpgradeService FileResponseBody ResponseInterceptor 网络请求使用的是Retrofit2+Rxjava2
"><meta property="og:url" content="https://zole.life/p/android%E5%BA%94%E7%94%A8%E5%86%85%E4%B8%8B%E8%BD%BD%E5%B9%B6%E6%9B%B4%E6%96%B0apk/"><meta property="og:site_name" content="3702"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Android"><meta property="article:tag" content="kotlin"><meta property="article:published_time" content="2018-05-19T10:07:55+00:00"><meta property="article:modified_time" content="2018-05-19T10:07:55+00:00"><meta name=twitter:title content="Android应用内下载并更新APK"><meta name=twitter:description content="背景 公司的APP之前一直是放在公司服务器，没有发布到应用市场，每次发布新版本用户更新都很麻烦。前段时间抽时间写了个应用内下载APK并更新的模块。 整个模块主要的几个类:
UpgradeManager UpgradeService FileResponseBody ResponseInterceptor 网络请求使用的是Retrofit2+Rxjava2
"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/zole_hu6c40e7c739345855743ed1c4f74e2379_188935_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>3702</a></h1><h2 class=site-description>槑头脑和她脑公的地盘</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E5%8D%9A%E5%AE%A2/>博客</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/android%E5%BA%94%E7%94%A8%E5%86%85%E4%B8%8B%E8%BD%BD%E5%B9%B6%E6%9B%B4%E6%96%B0apk/>Android应用内下载并更新APK</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>May 19, 2018</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>6 minute read</time></div></footer></div></header><section class=article-content><h1 id=背景>背景</h1><p>公司的APP之前一直是放在公司服务器，没有发布到应用市场，每次发布新版本用户更新都很麻烦。前段时间抽时间写了个应用内下载APK并更新的模块。
整个模块主要的几个类:</p><ul><li>UpgradeManager</li><li>UpgradeService</li><li>FileResponseBody</li><li>ResponseInterceptor</li></ul><p>网络请求使用的是Retrofit2+Rxjava2</p><h1 id=upgrademanager>UpgradeManager</h1><p>该类主要实现</p><ul><li>检查最新版本</li><li>升级信息提示</li><li>安装APK</li><li>删除冗余APK文件</li></ul><h2 id=检查最新版本>检查最新版本</h2><p>调用服务器提供的版本比对接口，将本地的版本名称提取出来封装为JSON字符串发送到服务器，根据服务器的返回结果做对应处理</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl> <span class=k>private</span> <span class=k>fun</span> <span class=nf>checkUpdate</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>disposableObserver</span><span class=p>:</span> <span class=n>DisposableObserver</span><span class=p>&lt;</span><span class=n>UpdateAck</span><span class=p>&gt;)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>pm</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>packageManager</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>versionName</span> <span class=p>=</span> <span class=n>pm</span><span class=p>.</span><span class=n>getPackageInfo</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=n>applicationInfo</span><span class=p>.</span><span class=n>packageName</span><span class=p>,</span> <span class=m>0</span><span class=p>).</span><span class=n>versionName</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>jsonObject</span> <span class=p>=</span> <span class=n>JSONObject</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>jsonObject</span><span class=p>.</span><span class=n>put</span><span class=p>(</span><span class=s2>&#34;versionName&#34;</span><span class=p>,</span> <span class=n>versionName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>LogUtil</span><span class=p>.</span><span class=n>d</span><span class=p>(</span><span class=n>tag</span><span class=p>,</span> <span class=n>jsonObject</span><span class=p>.</span><span class=n>toString</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>RetrofitClient</span><span class=p>.</span><span class=n>removeMethod</span><span class=p>(</span><span class=n>API</span><span class=p>.</span><span class=n>METHOD</span><span class=p>.</span><span class=n>CHECK_UPDATE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>checkUpdateCall</span> <span class=p>=</span> <span class=n>RetrofitClient</span><span class=p>.</span><span class=n>apiService</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>checkNewVer</span><span class=p>(</span><span class=n>RetrofitClient</span><span class=p>.</span><span class=n>body</span><span class=p>(</span><span class=n>API</span><span class=p>.</span><span class=n>METHOD</span><span class=p>.</span><span class=n>CHECK_UPDATE</span><span class=p>,</span> <span class=n>jsonObject</span><span class=p>.</span><span class=n>toString</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>compose</span><span class=p>(</span><span class=n>RetrofitClient</span><span class=p>.</span><span class=n>io2main</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>subscribeWith</span><span class=p>(</span><span class=n>disposableObserver</span><span class=p>)</span>    
</span></span><span class=line><span class=cl>        <span class=n>RetrofitClient</span><span class=p>.</span><span class=n>addMethod</span><span class=p>(</span><span class=n>javaClass</span><span class=p>.</span><span class=n>name</span><span class=p>,</span> <span class=n>API</span><span class=p>.</span><span class=n>METHOD</span><span class=p>.</span><span class=n>CHECK_UPDATE</span><span class=p>,</span> <span class=n>checkUpdateCall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>下面贴出来的是手动检查升级的代码，无论是否需要升级都有相应提示，还需要一个<code>backgroundCheck(context: Context)</code>方法，在APP启动时调用，无需升级时不弹出提示打扰用户，代码就不贴了，只需省略部分提示代码。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl>     <span class=k>fun</span> <span class=nf>manualCheck</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>disposableObserver</span> <span class=p>=</span> <span class=k>object</span> <span class=err>: </span><span class=nc>DisposableObserver</span><span class=p>&lt;</span><span class=n>UpdateAck</span><span class=p>&gt;()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>override</span> <span class=k>fun</span> <span class=nf>onComplete</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>override</span> <span class=k>fun</span> <span class=nf>onNext</span><span class=p>(</span><span class=n>t</span><span class=p>:</span> <span class=n>UpdateAck</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>LogUtil</span><span class=p>.</span><span class=n>d</span><span class=p>(</span><span class=n>tag</span><span class=p>,</span> <span class=n>t</span><span class=p>.</span><span class=n>toString</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=k>val</span> <span class=py>responseData</span> <span class=p>=</span> <span class=n>t</span><span class=p>.</span><span class=n>responseData</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>t</span><span class=p>.</span><span class=n>result</span> <span class=o>==</span> <span class=s2>&#34;T&#34;</span> <span class=o>&amp;&amp;</span> <span class=n>responseData</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//无错误信息
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=p>(</span><span class=n>responseData</span><span class=p>.</span><span class=n>errorMessage</span><span class=p>.</span><span class=n>isBlank</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>//服务器存在不同版本
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=k>if</span> <span class=p>(</span><span class=n>responseData</span><span class=p>.</span><span class=n>isNeedUpgrade</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=k>val</span> <span class=py>str</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>getString</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>string</span><span class=p>.</span><span class=n>need_upgrade</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                            <span class=k>val</span> <span class=py>msg</span> <span class=p>=</span> <span class=n>String</span><span class=p>.</span><span class=n>format</span><span class=p>(</span><span class=n>str</span><span class=p>,</span> <span class=n>responseData</span><span class=p>.</span><span class=n>versionName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                            <span class=k>val</span> <span class=py>upgradeVerName</span> <span class=p>=</span> <span class=s2>&#34;yourAppName&#34;</span> <span class=p>+</span> <span class=n>responseData</span><span class=p>.</span><span class=n>versionName</span>
</span></span><span class=line><span class=cl>                            <span class=n>showDialog</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>msg</span><span class=p>,</span> <span class=n>responseData</span><span class=p>.</span><span class=n>upgradeUrl</span><span class=p>,</span> <span class=n>upgradeVerName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=k>val</span> <span class=py>msg</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>getString</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>string</span><span class=p>.</span><span class=n>no_need_upgrade</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                            <span class=n>showDialog</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>showDialog</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>responseData</span><span class=p>.</span><span class=n>errorMessage</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>showDialog</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>t</span><span class=p>.</span><span class=n>errorMsg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>override</span> <span class=k>fun</span> <span class=nf>onError</span><span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>Throwable</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>LogUtil</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=n>tag</span><span class=p>,</span> <span class=n>e</span><span class=p>.</span><span class=n>message</span><span class=p>.</span><span class=n>toString</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=n>showDialog</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>context</span><span class=p>.</span><span class=n>getString</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>string</span><span class=p>.</span><span class=n>network_state</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>checkUpdate</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>disposableObserver</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=升级信息提示>升级信息提示</h2><p><code>showDialog</code>方法中为<code>url</code>和<code>versionName</code>参数设置了默认值null，当不是提示版本有版本需要更新时可以只传两个参数，这样能使代码看起来更简洁。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl>  <span class=k>private</span> <span class=k>fun</span> <span class=nf>showDialog</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>?,</span> <span class=n>msg</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span> <span class=n>url</span><span class=p>:</span> <span class=n>String</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span><span class=p>,</span> <span class=n>versionName</span><span class=p>:</span> <span class=n>String</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//防止activity销毁后弹出提示导致程序崩溃
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>context</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>builder</span> <span class=p>=</span> <span class=n>AlertDialog</span><span class=p>.</span><span class=n>Builder</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>builder</span><span class=p>.</span><span class=n>setMessage</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>.</span><span class=n>setPositiveButton</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>string</span><span class=p>.</span><span class=n>ok</span><span class=p>)</span> <span class=p>{</span> <span class=n>p0</span><span class=p>,</span> <span class=n>_</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=n>p0</span><span class=p>.</span><span class=n>dismiss</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                        <span class=c1>//有新版本时启动更新流程
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=k>if</span> <span class=p>(</span><span class=n>url</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=k>if</span> <span class=p>(!</span><span class=n>hasDownLoad</span><span class=p>(</span><span class=n>versionName</span><span class=o>!!</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=n>LogUtil</span><span class=p>.</span><span class=n>d</span><span class=p>(</span><span class=n>tag</span><span class=p>,</span> <span class=s2>&#34;未下载</span><span class=si>$versionName</span><span class=s2>&#34;</span> <span class=p>+</span> <span class=s2>&#34;APK&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                <span class=n>startDownLoadService</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>url</span><span class=p>,</span> <span class=n>versionName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=n>LogUtil</span><span class=p>.</span><span class=n>d</span><span class=p>(</span><span class=n>tag</span><span class=p>,</span> <span class=s2>&#34;已下载</span><span class=si>$versionName</span><span class=s2>&#34;</span> <span class=p>+</span> <span class=s2>&#34;APK&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                <span class=n>installAPK</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>versionName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>.</span><span class=n>setNegativeButton</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>string</span><span class=p>.</span><span class=n>cancel</span><span class=p>)</span> <span class=p>{</span> <span class=n>p0</span><span class=p>,</span> <span class=n>_</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=n>p0</span><span class=p>.</span><span class=n>dismiss</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=p>}.</span><span class=n>create</span><span class=p>().</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1>//通过EventBus通知AppInfo页面隐藏网络请求的旋转菊花
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>post</span><span class=p>(</span><span class=n>EventMsg</span><span class=p>.</span><span class=n>AppInfoDismissProgressBar</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果当前版本和服务器上的版本不一致时，先调用<code>hasDownload(versionName!!)</code>方法检查指定路径是否存在最新的APK文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>fun</span> <span class=nf>hasDownLoad</span><span class=p>(</span><span class=n>versionName</span><span class=p>:</span> <span class=n>String</span><span class=p>):</span> <span class=n>Boolean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>apkFile</span><span class=p>(</span><span class=n>versionName</span><span class=p>).</span><span class=n>exists</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>apkFile</span><span class=p>(</span><span class=n>versionName</span><span class=p>:</span> <span class=n>String</span><span class=p>):</span> <span class=n>File</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>File</span><span class=p>(</span><span class=n>Environment</span><span class=p>.</span><span class=n>getExternalStoragePublicDirectory</span><span class=p>(</span><span class=n>Environment</span><span class=p>.</span><span class=n>DIRECTORY_DOWNLOADS</span><span class=p>).</span><span class=n>absolutePath</span> <span class=p>+</span> <span class=s2>&#34;/&#34;</span> <span class=p>+</span> <span class=n>versionName</span> <span class=p>+</span> <span class=s2>&#34;.apk&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果存在则直接进行安装，如果没有最新版的APK文件，则通过 <code>startDownLoadService(context, url, versionName)</code>来开启UpgradeService进行后台下载。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl>  <span class=k>private</span> <span class=k>fun</span> <span class=nf>startDownLoadService</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>url</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span> <span class=n>versionName</span><span class=p>:</span> <span class=n>String</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>intent</span> <span class=p>=</span> <span class=n>Intent</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>UpgradeService</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span><span class=p>.</span><span class=n>putExtra</span><span class=p>(</span><span class=s2>&#34;url&#34;</span><span class=p>,</span> <span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span><span class=p>.</span><span class=n>putExtra</span><span class=p>(</span><span class=s2>&#34;versionName&#34;</span><span class=p>,</span> <span class=n>versionName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=p>.</span><span class=n>startService</span><span class=p>(</span><span class=n>intent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=安装apk>安装APK</h2><p>安装代码:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl>    <span class=k>private</span> <span class=k>fun</span> <span class=nf>installAPK</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>versionName</span><span class=p>:</span> <span class=n>String</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>install</span> <span class=p>=</span> <span class=n>installIntent</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>versionName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=p>.</span><span class=n>startActivity</span><span class=p>(</span><span class=n>install</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>fun</span> <span class=nf>installIntent</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span> <span class=n>versionName</span><span class=p>:</span> <span class=n>String</span><span class=p>):</span> <span class=n>Intent</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>file</span> <span class=p>=</span> <span class=n>apkFile</span><span class=p>(</span><span class=n>versionName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>//7.0关于读写文件有更严格的要求，需要配置FileProvider
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=py>uri</span> <span class=p>=</span> <span class=k>if</span> <span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=n>VERSION</span><span class=p>.</span><span class=n>SDK_INT</span> <span class=o>&gt;=</span> <span class=n>Build</span><span class=p>.</span><span class=n>VERSION_CODES</span><span class=p>.</span><span class=n>N</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>FileProvider</span><span class=p>.</span><span class=n>getUriForFile</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=s2>&#34;com.xxxxx.fileprovider&#34;</span><span class=p>,</span> <span class=k>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Uri</span><span class=p>.</span><span class=n>fromFile</span><span class=p>(</span><span class=k>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>install</span> <span class=p>=</span> <span class=n>Intent</span><span class=p>(</span><span class=n>Intent</span><span class=p>.</span><span class=n>ACTION_VIEW</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>install</span><span class=p>.</span><span class=n>addFlags</span><span class=p>(</span><span class=n>Intent</span><span class=p>.</span><span class=n>FLAG_GRANT_READ_URI_PERMISSION</span><span class=p>)</span><span class=c1>//为7.0添加
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>install</span><span class=p>.</span><span class=n>addFlags</span><span class=p>(</span><span class=n>Intent</span><span class=p>.</span><span class=n>FLAG_ACTIVITY_NEW_TASK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>install</span><span class=p>.</span><span class=n>setDataAndType</span><span class=p>(</span><span class=n>uri</span><span class=p>,</span> <span class=s2>&#34;application/vnd.android.package-archive&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>install</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=删除冗余apk文件>删除冗余APK文件</h2><p>在启动页面调用 <code>UpgradeManager.cleanOldApk(ctx)</code>检查当前运行的APP版本和指定路径的APK <code>versionName</code>是否相同，相同则删除</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>fun</span> <span class=nf>cleanOldApk</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>pm</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>packageManager</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>locVersionName</span> <span class=p>=</span> <span class=n>pm</span><span class=p>.</span><span class=n>getPackageInfo</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=n>applicationInfo</span><span class=p>.</span><span class=n>packageName</span><span class=p>,</span> <span class=m>0</span><span class=p>).</span><span class=n>versionName</span>
</span></span><span class=line><span class=cl>        <span class=c1>//已下载的APK和当前安装的版本相同,删除下载的APK
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>hasDownLoad</span><span class=p>(</span><span class=s2>&#34;yourAppName</span><span class=si>$locVersionName</span><span class=s2>&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>apkFile</span><span class=p>(</span><span class=s2>&#34;yourAppName</span><span class=si>$locVersionName</span><span class=s2>&#34;</span><span class=p>).</span><span class=n>delete</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=upgradeservice>UpgradeService</h1><p>该类主要实现</p><ul><li>APK<code>下载</code> <code>保存</code> <code>安装</code></li><li>通知中心更新下载进度</li></ul><h2 id=oncreate>onCreate</h2><p><strong>初始化升级服务</strong></p><ol><li>注册EventBus并发送粘性广播提示升级服务已启动</li><li>初始化通知中心对象，设置标题，信息，图标</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>LogUtil</span><span class=p>.</span><span class=n>d</span><span class=p>(</span><span class=n>tag</span><span class=p>,</span> <span class=s2>&#34;onCreate&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>register</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>postSticky</span><span class=p>(</span><span class=n>EventMsg</span><span class=p>.</span><span class=n>UpgradeServiceState</span><span class=p>(</span><span class=k>true</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>notificationManager</span> <span class=p>=</span> <span class=n>getSystemService</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=n>NOTIFICATION_SERVICE</span><span class=p>)</span> <span class=k>as</span> <span class=n>NotificationManager</span>
</span></span><span class=line><span class=cl>        <span class=n>notificationBuilder</span> <span class=p>=</span> <span class=n>NotificationCompat</span><span class=p>.</span><span class=n>Builder</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=s2>&#34;upgrade&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>notificationBuilder</span><span class=p>.</span><span class=n>setContentTitle</span><span class=p>(</span><span class=n>getString</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>string</span><span class=p>.</span><span class=n>notification_upgrade_title</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>setContentText</span><span class=p>(</span><span class=n>getString</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>string</span><span class=p>.</span><span class=n>notification_loading</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>setSmallIcon</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>mipmap</span><span class=p>.</span><span class=n>mainlancher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>notificationBuilder</span><span class=p>.</span><span class=n>priority</span> <span class=p>=</span> <span class=n>PRIORITY_HIGH</span>
</span></span><span class=line><span class=cl>        <span class=c1>//点击后自动移除通知
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>notificationBuilder</span><span class=p>.</span><span class=n>setAutoCancel</span><span class=p>(</span><span class=k>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=onstartcommand>onStartCommand</h2><p><strong>开始下载</strong>
通过<code>isDowloading</code>和<code>needDownLoad</code>判断是否需要执行下载操作</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl> <span class=k>override</span> <span class=k>fun</span> <span class=nf>onStartCommand</span><span class=p>(</span><span class=n>intent</span><span class=p>:</span> <span class=n>Intent</span><span class=p>,</span> <span class=n>flags</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span> <span class=n>startId</span><span class=p>:</span> <span class=n>Int</span><span class=p>):</span> <span class=n>Int</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>LogUtil</span><span class=p>.</span><span class=n>d</span><span class=p>(</span><span class=n>tag</span><span class=p>,</span> <span class=s2>&#34;onStartCommand：startId</span><span class=si>$startId</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>url</span> <span class=p>=</span> <span class=n>intent</span><span class=p>.</span><span class=n>getStringExtra</span><span class=p>(</span><span class=s2>&#34;url&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>versionName</span> <span class=p>=</span> <span class=n>intent</span><span class=p>.</span><span class=n>getStringExtra</span><span class=p>(</span><span class=s2>&#34;versionName&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>needDownLoad</span> <span class=p>=</span> <span class=p>!</span><span class=n>UpgradeManager</span><span class=p>.</span><span class=n>hasDownLoad</span><span class=p>(</span><span class=n>versionName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!is</span><span class=n>Dowloading</span> <span class=o>&amp;&amp;</span> <span class=n>needDownLoad</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>retryCount</span> <span class=p>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>            <span class=n>downLoadAPK</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>LogUtil</span><span class=p>.</span><span class=n>d</span><span class=p>(</span><span class=n>tag</span><span class=p>,</span> <span class=s2>&#34;已有下载任务在执行！！！！&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>super</span><span class=p>.</span><span class=n>onStartCommand</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=n>startId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=apk下载并保存并安装>APK下载并保存并安装</h2><h3 id=downloadapk>downLoadAPK</h3><p><code>retryCount</code>重试次数，目前设置的重试次数为7次。
下载开始后将<code>isDowloading</code>置为<code>true</code>
请求成功后调用<code>saveFile(fileResponseBody: ResponseBody)</code>读取数据写入本地</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl> <span class=k>private</span> <span class=k>fun</span> <span class=nf>downLoadAPK</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//下载次数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>retryCount</span><span class=o>++</span>
</span></span><span class=line><span class=cl>        <span class=n>LogUtil</span><span class=p>.</span><span class=n>d</span><span class=p>(</span><span class=n>tag</span><span class=p>,</span> <span class=s2>&#34;开始下载&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>RetrofitClient</span><span class=p>.</span><span class=n>removeMethod</span><span class=p>(</span><span class=s2>&#34;downloadAPK&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>downLoadCall</span> <span class=p>=</span> <span class=n>RetrofitClient</span><span class=p>.</span><span class=n>apiService</span><span class=p>.</span><span class=n>getApk</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>subscribeOn</span><span class=p>(</span><span class=n>Schedulers</span><span class=p>.</span><span class=n>io</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>observeOn</span><span class=p>(</span><span class=n>Schedulers</span><span class=p>.</span><span class=n>io</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>subscribeWith</span><span class=p>(</span><span class=k>object</span> <span class=err>: </span><span class=nc>DisposableObserver</span><span class=p>&lt;</span><span class=n>ResponseBody</span><span class=p>&gt;()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onStart</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>isDowloading</span> <span class=p>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onComplete</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>LogUtil</span><span class=p>.</span><span class=n>d</span><span class=p>(</span><span class=n>tag</span><span class=p>,</span> <span class=s2>&#34;onComplete&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onNext</span><span class=p>(</span><span class=n>t</span><span class=p>:</span> <span class=n>ResponseBody</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>LogUtil</span><span class=p>.</span><span class=n>d</span><span class=p>(</span><span class=n>tag</span><span class=p>,</span> <span class=s2>&#34;onNext&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>saveFile</span><span class=p>(</span><span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onError</span><span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>Throwable</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>isDowloading</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>                        <span class=n>LogUtil</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=n>tag</span><span class=p>,</span> <span class=n>e</span><span class=p>.</span><span class=n>message</span><span class=p>.</span><span class=n>toString</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>RetrofitClient</span><span class=p>.</span><span class=n>addMethod</span><span class=p>(</span><span class=n>javaClass</span><span class=p>.</span><span class=n>name</span><span class=p>,</span> <span class=s2>&#34;downloadAPK&#34;</span><span class=p>,</span> <span class=n>downLoadCall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=savefile>saveFile</h3><p>写入文件到本地<code>Download</code>公共文件夹
<strong>期间若发生错误</strong></p><ol><li>通过<code>UpgradeManager.apkFile(versionName).delete()</code>清除未下载完的文件</li><li>通过<code> updateNotification(R.string.notification_err_retry)</code>更新通知中心提示</li><li>通过<code>retryCount</code>判断是否需要重试，超过重试上限则更新通知中心并调用<code>stopSelf()</code>停止服务</li></ol><p><strong>顺利保存到本地</strong>则调用<code>installAPK()</code>安装APK，并将<code>isDowloading</code>置为<code>false</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>private</span> <span class=k>fun</span> <span class=nf>saveFile</span><span class=p>(</span><span class=n>fileResponseBody</span><span class=p>:</span> <span class=n>ResponseBody</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Observable</span><span class=p>.</span><span class=n>create</span><span class=p>&lt;</span><span class=n>File</span><span class=p>&gt;</span> <span class=p>{</span> <span class=n>e</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>            <span class=k>var</span> <span class=py>inputStream</span><span class=p>:</span> <span class=n>InputStream</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>            <span class=k>var</span> <span class=py>fileOutputStream</span><span class=p>:</span> <span class=n>FileOutputStream</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>buffer</span> <span class=p>=</span> <span class=n>ByteArray</span><span class=p>(</span><span class=m>2048</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>apkFile</span> <span class=p>=</span> <span class=n>UpgradeManager</span><span class=p>.</span><span class=n>apkFile</span><span class=p>(</span><span class=n>versionName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>LogUtil</span><span class=p>.</span><span class=n>d</span><span class=p>(</span><span class=n>tag</span><span class=p>,</span> <span class=s2>&#34;保存文件到&#34;</span> <span class=p>+</span> <span class=n>apkFile</span><span class=p>.</span><span class=n>absolutePath</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>inputStream</span> <span class=p>=</span> <span class=n>fileResponseBody</span><span class=p>.</span><span class=n>byteStream</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>fileOutputStream</span> <span class=p>=</span> <span class=n>FileOutputStream</span><span class=p>(</span><span class=n>apkFile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>var</span> <span class=py>len</span> <span class=p>=</span> <span class=n>inputStream</span><span class=o>!!</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=p>(</span><span class=n>len</span> <span class=o>!=</span> <span class=p>-</span><span class=m>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>fileOutputStream</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=m>0</span><span class=p>,</span> <span class=n>len</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>len</span> <span class=p>=</span> <span class=n>inputStream</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=n>fileOutputStream</span><span class=p>.</span><span class=n>flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=p>.</span><span class=n>onNext</span><span class=p>(</span><span class=n>apkFile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>err</span><span class=p>:</span> <span class=n>IOException</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=p>.</span><span class=n>onError</span><span class=p>(</span><span class=n>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>inputStream</span><span class=o>?.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>fileOutputStream</span><span class=o>?.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=p>.</span><span class=n>onComplete</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}.</span><span class=n>subscribeOn</span><span class=p>(</span><span class=n>Schedulers</span><span class=p>.</span><span class=n>io</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>observeOn</span><span class=p>(</span><span class=n>Schedulers</span><span class=p>.</span><span class=n>io</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>subscribe</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                    <span class=n>isDowloading</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>                    <span class=n>installAPK</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span> <span class=p>{</span> <span class=n>e</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=n>isDowloading</span> <span class=p>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>                    <span class=n>LogUtil</span><span class=p>.</span><span class=n>e</span><span class=p>(</span><span class=n>tag</span><span class=p>,</span> <span class=n>e</span><span class=p>.</span><span class=n>message</span><span class=p>.</span><span class=n>toString</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                    <span class=n>UpgradeManager</span><span class=p>.</span><span class=n>apkFile</span><span class=p>(</span><span class=n>versionName</span><span class=p>).</span><span class=n>delete</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=n>updateNotification</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>string</span><span class=p>.</span><span class=n>notification_err_retry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=n>retryCount</span> <span class=p>&lt;</span> <span class=m>7</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>downLoadAPK</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>updateNotification</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>string</span><span class=p>.</span><span class=n>notification_err_retry_later</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>stopSelf</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>updateNotification(resId: Int)</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl> <span class=k>private</span> <span class=k>fun</span> <span class=nf>updateNotification</span><span class=p>(</span><span class=n>resId</span><span class=p>:</span> <span class=n>Int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>string</span> <span class=p>=</span> <span class=n>getString</span><span class=p>(</span><span class=n>resId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>notificationBuilder</span><span class=p>.</span><span class=n>setContentText</span><span class=p>(</span><span class=n>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>notificationManager</span><span class=p>.</span><span class=n>notify</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>notificationBuilder</span><span class=p>.</span><span class=n>build</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=installapk>installAPK</h3><ol><li>通过<code>notificationBuilder.setProgress(0, 0, false)</code>移除通知中的下载进度条</li><li>通过<code>notificationBuilder.setContentIntent(pendingIntent)</code>设置通知的点击响应，以便用户在安装界面点击了<code>取消</code>还能通过点击通知进行安装</li><li>通过<code> updateNotification(R.string.notification_load_complete)</code>更新通知中心提示</li><li>执行安装</li><li>通过<code>stopSelf()</code>停止服务</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl> <span class=k>private</span> <span class=k>fun</span> <span class=nf>installAPK</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>notificationBuilder</span><span class=p>.</span><span class=n>setProgress</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=m>0</span><span class=p>,</span> <span class=k>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>install</span> <span class=p>=</span> <span class=n>UpgradeManager</span><span class=p>.</span><span class=n>installIntent</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>,</span> <span class=n>versionName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>pendingIntent</span> <span class=p>=</span> <span class=n>PendingIntent</span><span class=p>.</span><span class=n>getActivity</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=m>0</span><span class=p>,</span> <span class=n>install</span><span class=p>,</span> <span class=n>PendingIntent</span><span class=p>.</span><span class=n>FLAG_UPDATE_CURRENT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>notificationBuilder</span><span class=p>.</span><span class=n>setContentIntent</span><span class=p>(</span><span class=n>pendingIntent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>updateNotification</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>string</span><span class=p>.</span><span class=n>notification_load_complete</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>startActivity</span><span class=p>(</span><span class=n>install</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>stopSelf</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=ondestroy>onDestroy</h2><ol><li>停止所有当前类名相关网络请求</li><li>发送粘性广播通知更新服务已停止</li><li>注销<code>EventBus</code></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>override</span> <span class=k>fun</span> <span class=nf>onDestroy</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onDestroy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>LogUtil</span><span class=p>.</span><span class=n>d</span><span class=p>(</span><span class=n>tag</span><span class=p>,</span> <span class=s2>&#34;onDestroy&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>RetrofitClient</span><span class=p>.</span><span class=n>removeAll</span><span class=p>(</span><span class=n>javaClass</span><span class=p>.</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>postSticky</span><span class=p>(</span><span class=n>EventMsg</span><span class=p>.</span><span class=n>UpgradeServiceState</span><span class=p>(</span><span class=k>false</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>unregister</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=下载进度百分比>下载进度百分比</h2><p>下载进度更新通过<code>EventBus</code>+<code>ResponseInterceptor</code>+<code>FileResponseBody</code>实现</p><ol><li>自定义<code>ResponseBody</code>即下文的<code>FileResponseBody</code>，重写<code>ResponseBody</code>的<code>fun source()</code>方法，在该方法内获取当前下载进度并通过<code>EventBus</code>广播</li><li>自定义<code>Interceptor</code>即下文的<code>ResponseInterceptor</code>，将原<code>ResponseBody</code>替换为<code>FileResponseBody</code>以获取下载进度</li><li>在创建<code>OkHttpClient</code>的过程中通过<code>addNetworkInterceptor(ResponseInterceptor())</code>将自定义网络拦截器添加进去</li><li>在<code>UpgradeService</code>接收下载进度并更新到通知中心</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl>    <span class=nd>@Subscribe</span><span class=p>(</span><span class=n>threadMode</span> <span class=p>=</span> <span class=n>ThreadMode</span><span class=p>.</span><span class=n>BACKGROUND</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>downloadProgress</span><span class=p>(</span><span class=n>event</span><span class=p>:</span> <span class=n>EventMsg</span><span class=p>.</span><span class=n>FileLoading</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>progress</span> <span class=p>=</span> <span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=n>bytesRead</span> <span class=p>/</span> <span class=n>event</span><span class=p>.</span><span class=n>contentLength</span><span class=p>)</span> <span class=p>*</span> <span class=m>100</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>progressStr</span> <span class=p>=</span> <span class=n>String</span><span class=p>.</span><span class=n>format</span><span class=p>(</span><span class=s2>&#34;%.2f&#34;</span><span class=p>,</span> <span class=n>progress</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>//以1%为步进，大量更新会导致通知中心下拉卡死
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>progressStr</span><span class=p>.</span><span class=n>endsWith</span><span class=p>(</span><span class=s2>&#34;00&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>notificationBuilder</span><span class=p>.</span><span class=n>setProgress</span><span class=p>(</span><span class=m>100</span><span class=p>,</span> <span class=n>progress</span><span class=p>.</span><span class=n>toInt</span><span class=p>(),</span> <span class=k>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>notificationManager</span><span class=p>.</span><span class=n>notify</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>notificationBuilder</span><span class=p>.</span><span class=n>build</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=fileresponsebody>FileResponseBody</h1><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>FileResponseBody</span><span class=p>(</span><span class=k>private</span> <span class=k>val</span> <span class=py>originalResponse</span><span class=p>:</span> <span class=n>Response</span><span class=p>)</span> <span class=p>:</span> <span class=n>ResponseBody</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>var</span> <span class=py>bufferedSource</span><span class=p>:</span> <span class=n>BufferedSource</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>init</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>LogUtil</span><span class=p>.</span><span class=n>d</span><span class=p>(</span><span class=s2>&#34;FileResponseBody init&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>contentType</span><span class=p>():</span> <span class=n>MediaType</span><span class=p>?</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>originalResponse</span><span class=p>.</span><span class=n>body</span><span class=p>()</span><span class=o>?.</span><span class=n>contentType</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>contentLength</span><span class=p>():</span> <span class=n>Long</span> <span class=p>{</span><span class=c1>// 返回文件的总长度，也就是进度条的max
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>originalResponse</span><span class=p>.</span><span class=n>body</span><span class=p>()</span><span class=o>!!</span><span class=p>.</span><span class=n>contentLength</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>source</span><span class=p>():</span> <span class=n>BufferedSource</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>bufferedSource</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>bufferedSource</span> <span class=p>=</span> <span class=n>Okio</span><span class=p>.</span><span class=n>buffer</span><span class=p>(</span><span class=n>source</span><span class=p>(</span><span class=n>originalResponse</span><span class=p>.</span><span class=n>body</span><span class=p>()</span><span class=o>!!</span><span class=p>.</span><span class=n>source</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>bufferedSource</span><span class=o>!!</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>fun</span> <span class=nf>source</span><span class=p>(</span><span class=n>source</span><span class=p>:</span> <span class=n>Source</span><span class=p>):</span> <span class=n>Source</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>object</span> <span class=err>: </span><span class=nc>ForwardingSource</span><span class=p>(</span><span class=n>source</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>var</span> <span class=py>totalBytesRead</span> <span class=p>=</span> <span class=m>0L</span>
</span></span><span class=line><span class=cl>            <span class=k>override</span> <span class=k>fun</span> <span class=nf>read</span><span class=p>(</span><span class=n>sink</span><span class=p>:</span> <span class=n>Buffer</span><span class=p>,</span> <span class=n>byteCount</span><span class=p>:</span> <span class=n>Long</span><span class=p>):</span> <span class=n>Long</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>val</span> <span class=py>bytesRead</span> <span class=p>=</span> <span class=k>super</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>sink</span><span class=p>,</span> <span class=n>byteCount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=c1>// read() returns the number of bytes read, or -1 if this source is exhausted.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>totalBytesRead</span> <span class=o>+=</span> <span class=k>if</span> <span class=p>(</span><span class=n>bytesRead</span> <span class=o>==</span> <span class=p>-</span><span class=m>1L</span><span class=p>)</span> <span class=m>0</span> <span class=k>else</span> <span class=n>bytesRead</span>
</span></span><span class=line><span class=cl>                <span class=n>LogUtil</span><span class=p>.</span><span class=n>d</span><span class=p>(</span><span class=s2>&#34;readed:&#34;</span><span class=p>,</span> <span class=n>totalBytesRead</span><span class=p>.</span><span class=n>toString</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=n>EventBus</span><span class=p>.</span><span class=n>getDefault</span><span class=p>().</span><span class=n>post</span><span class=p>(</span><span class=n>EventMsg</span><span class=p>.</span><span class=n>FileLoading</span><span class=p>(</span><span class=n>contentLength</span><span class=p>().</span><span class=n>toFloat</span><span class=p>(),</span> <span class=n>totalBytesRead</span><span class=p>.</span><span class=n>toFloat</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>bytesRead</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=responseinterceptor>ResponseInterceptor</h1><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl> <span class=k>private</span> <span class=k>class</span> <span class=nc>ResponseInterceptor</span> <span class=p>:</span> <span class=n>Interceptor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>intercept</span><span class=p>(</span><span class=n>chain</span><span class=p>:</span> <span class=n>Interceptor</span><span class=p>.</span><span class=n>Chain</span><span class=p>):</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>request</span> <span class=p>=</span> <span class=n>chain</span><span class=p>.</span><span class=n>request</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>LogUtil</span><span class=p>.</span><span class=n>d</span><span class=p>(</span><span class=s2>&#34;request.url&#34;</span><span class=p>,</span> <span class=n>request</span><span class=p>.</span><span class=n>url</span><span class=p>().</span><span class=n>toString</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=c1>//地址为下载APK的地址时替换为FileResponseBody
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=n>url</span><span class=p>().</span><span class=n>toString</span><span class=p>().</span><span class=n>startsWith</span><span class=p>(</span><span class=s2>&#34;http://www.******.com&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>LogUtil</span><span class=p>.</span><span class=n>d</span><span class=p>(</span><span class=s2>&#34;new Response&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>val</span> <span class=py>response</span> <span class=p>=</span> <span class=n>chain</span><span class=p>.</span><span class=n>proceed</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>response</span><span class=p>.</span><span class=n>newBuilder</span><span class=p>().</span><span class=n>body</span><span class=p>(</span><span class=n>FileResponseBody</span><span class=p>(</span><span class=n>response</span><span class=p>)).</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>chain</span><span class=p>.</span><span class=n>proceed</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/tags/android/>Android</a>
<a href=/tags/kotlin/>kotlin</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/javascript-in-android/><div class=article-details><h2 class=article-title>JavaScript in Android</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2022 3702</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.13.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#检查最新版本>检查最新版本</a></li><li><a href=#升级信息提示>升级信息提示</a></li><li><a href=#安装apk>安装APK</a></li><li><a href=#删除冗余apk文件>删除冗余APK文件</a></li></ol><ol><li><a href=#oncreate>onCreate</a></li><li><a href=#onstartcommand>onStartCommand</a></li><li><a href=#apk下载并保存并安装>APK下载并保存并安装</a><ol><li><a href=#downloadapk>downLoadAPK</a></li><li><a href=#savefile>saveFile</a></li><li><a href=#installapk>installAPK</a></li></ol></li><li><a href=#ondestroy>onDestroy</a></li><li><a href=#下载进度百分比>下载进度百分比</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>