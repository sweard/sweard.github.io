<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="èƒŒæ™¯ å…¬å¸çš„APPä¹‹å‰ä¸€ç›´æ˜¯æ”¾åœ¨å…¬å¸æœåŠ¡å™¨ï¼Œæ²¡æœ‰å‘å¸ƒåˆ°åº”ç”¨å¸‚åœºï¼Œæ¯æ¬¡å‘å¸ƒæ–°ç‰ˆæœ¬ç”¨æˆ·æ›´æ–°éƒ½å¾ˆéº»çƒ¦ã€‚å‰æ®µæ—¶é—´æŠ½æ—¶é—´å†™äº†ä¸ªåº”ç”¨å†…ä¸‹è½½APKå¹¶æ›´æ–°çš„æ¨¡å—ã€‚ æ•´ä¸ªæ¨¡å—ä¸»è¦çš„å‡ ä¸ªç±»:
 UpgradeManager UpgradeService FileResponseBody ResponseInterceptor  ç½‘ç»œè¯·æ±‚ä½¿ç”¨çš„æ˜¯Retrofit2+Rxjava2"><title>Androidåº”ç”¨å†…ä¸‹è½½å¹¶æ›´æ–°APK</title><link rel=canonical href=https://zole.life/p/android%E5%BA%94%E7%94%A8%E5%86%85%E4%B8%8B%E8%BD%BD%E5%B9%B6%E6%9B%B4%E6%96%B0apk/><link rel=stylesheet href=https://zole.life/scss/style.min.css><meta property="og:title" content="Androidåº”ç”¨å†…ä¸‹è½½å¹¶æ›´æ–°APK"><meta property="og:description" content="èƒŒæ™¯ å…¬å¸çš„APPä¹‹å‰ä¸€ç›´æ˜¯æ”¾åœ¨å…¬å¸æœåŠ¡å™¨ï¼Œæ²¡æœ‰å‘å¸ƒåˆ°åº”ç”¨å¸‚åœºï¼Œæ¯æ¬¡å‘å¸ƒæ–°ç‰ˆæœ¬ç”¨æˆ·æ›´æ–°éƒ½å¾ˆéº»çƒ¦ã€‚å‰æ®µæ—¶é—´æŠ½æ—¶é—´å†™äº†ä¸ªåº”ç”¨å†…ä¸‹è½½APKå¹¶æ›´æ–°çš„æ¨¡å—ã€‚ æ•´ä¸ªæ¨¡å—ä¸»è¦çš„å‡ ä¸ªç±»:
 UpgradeManager UpgradeService FileResponseBody ResponseInterceptor  ç½‘ç»œè¯·æ±‚ä½¿ç”¨çš„æ˜¯Retrofit2+Rxjava2"><meta property="og:url" content="https://zole.life/p/android%E5%BA%94%E7%94%A8%E5%86%85%E4%B8%8B%E8%BD%BD%E5%B9%B6%E6%9B%B4%E6%96%B0apk/"><meta property="og:site_name" content="3702"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Android"><meta property="article:tag" content="kotlin"><meta property="article:published_time" content="2018-05-19T10:07:55+00:00"><meta property="article:modified_time" content="2018-05-19T10:07:55+00:00"><meta name=twitter:title content="Androidåº”ç”¨å†…ä¸‹è½½å¹¶æ›´æ–°APK"><meta name=twitter:description content="èƒŒæ™¯ å…¬å¸çš„APPä¹‹å‰ä¸€ç›´æ˜¯æ”¾åœ¨å…¬å¸æœåŠ¡å™¨ï¼Œæ²¡æœ‰å‘å¸ƒåˆ°åº”ç”¨å¸‚åœºï¼Œæ¯æ¬¡å‘å¸ƒæ–°ç‰ˆæœ¬ç”¨æˆ·æ›´æ–°éƒ½å¾ˆéº»çƒ¦ã€‚å‰æ®µæ—¶é—´æŠ½æ—¶é—´å†™äº†ä¸ªåº”ç”¨å†…ä¸‹è½½APKå¹¶æ›´æ–°çš„æ¨¡å—ã€‚ æ•´ä¸ªæ¨¡å—ä¸»è¦çš„å‡ ä¸ªç±»:
 UpgradeManager UpgradeService FileResponseBody ResponseInterceptor  ç½‘ç»œè¯·æ±‚ä½¿ç”¨çš„æ˜¯Retrofit2+Rxjava2"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><div class="container extended flex on-phone--column align-items--flex-start article-page with-toolbar"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header class=site-info><figure class=site-avatar><img src=/img/zole_hu6c40e7c739345855743ed1c4f74e2379_188935_300x300_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
<span class=emoji>ğŸ¥</span></figure><h1 class=site-name><a href=https://zole.life>3702</a></h1><h2 class=site-description>æ§‘å¤´è„‘å’Œå¥¹è„‘å…¬çš„åœ°ç›˜</h2></header><nav class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li></nav></aside><main class="main full-width"><div id=article-toolbar><a href=https://zole.life class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E5%8D%9A%E5%AE%A2>åšå®¢</a></header><h2 class=article-title><a href=https://zole.life/p/android%E5%BA%94%E7%94%A8%E5%86%85%E4%B8%8B%E8%BD%BD%E5%B9%B6%E6%9B%B4%E6%96%B0apk/>Androidåº”ç”¨å†…ä¸‹è½½å¹¶æ›´æ–°APK</a></h2><footer class=article-time><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--published>May 19, 2018</time></footer></div></header><section class=article-content><h1 id=èƒŒæ™¯>èƒŒæ™¯</h1><p>å…¬å¸çš„APPä¹‹å‰ä¸€ç›´æ˜¯æ”¾åœ¨å…¬å¸æœåŠ¡å™¨ï¼Œæ²¡æœ‰å‘å¸ƒåˆ°åº”ç”¨å¸‚åœºï¼Œæ¯æ¬¡å‘å¸ƒæ–°ç‰ˆæœ¬ç”¨æˆ·æ›´æ–°éƒ½å¾ˆéº»çƒ¦ã€‚å‰æ®µæ—¶é—´æŠ½æ—¶é—´å†™äº†ä¸ªåº”ç”¨å†…ä¸‹è½½APKå¹¶æ›´æ–°çš„æ¨¡å—ã€‚
æ•´ä¸ªæ¨¡å—ä¸»è¦çš„å‡ ä¸ªç±»:</p><ul><li>UpgradeManager</li><li>UpgradeService</li><li>FileResponseBody</li><li>ResponseInterceptor</li></ul><p>ç½‘ç»œè¯·æ±‚ä½¿ç”¨çš„æ˜¯Retrofit2+Rxjava2</p><h1 id=upgrademanager>UpgradeManager</h1><p>è¯¥ç±»ä¸»è¦å®ç°</p><ul><li>æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬</li><li>å‡çº§ä¿¡æ¯æç¤º</li><li>å®‰è£…APK</li><li>åˆ é™¤å†—ä½™APKæ–‡ä»¶</li></ul><h2 id=æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬>æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬</h2><p>è°ƒç”¨æœåŠ¡å™¨æä¾›çš„ç‰ˆæœ¬æ¯”å¯¹æ¥å£ï¼Œå°†æœ¬åœ°çš„ç‰ˆæœ¬åç§°æå–å‡ºæ¥å°è£…ä¸ºJSONå­—ç¬¦ä¸²å‘é€åˆ°æœåŠ¡å™¨ï¼Œæ ¹æ®æœåŠ¡å™¨çš„è¿”å›ç»“æœåšå¯¹åº”å¤„ç†</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin> <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>checkUpdate</span>(context: Context, disposableObserver: DisposableObserver&lt;UpdateAck&gt;) {
        <span style=color:#66d9ef>val</span> pm = context.packageManager
        <span style=color:#66d9ef>val</span> versionName = pm.getPackageInfo(context.applicationInfo.packageName, <span style=color:#ae81ff>0</span>).versionName
        <span style=color:#66d9ef>val</span> jsonObject = JSONObject()
        jsonObject.put(<span style=color:#e6db74>&#34;versionName&#34;</span>, versionName)
        LogUtil.d(tag, jsonObject.toString())
        RetrofitClient.removeMethod(API.METHOD.CHECK_UPDATE)
        <span style=color:#66d9ef>val</span> checkUpdateCall = RetrofitClient.apiService
                .checkNewVer(RetrofitClient.body(API.METHOD.CHECK_UPDATE, jsonObject.toString()))
                .compose(RetrofitClient.io2main())
                .subscribeWith(disposableObserver)    
        RetrofitClient.addMethod(javaClass.name, API.METHOD.CHECK_UPDATE, checkUpdateCall)
    }
</code></pre></div><p>ä¸‹é¢è´´å‡ºæ¥çš„æ˜¯æ‰‹åŠ¨æ£€æŸ¥å‡çº§çš„ä»£ç ï¼Œæ— è®ºæ˜¯å¦éœ€è¦å‡çº§éƒ½æœ‰ç›¸åº”æç¤ºï¼Œè¿˜éœ€è¦ä¸€ä¸ª<code>backgroundCheck(context: Context)</code>æ–¹æ³•ï¼Œåœ¨APPå¯åŠ¨æ—¶è°ƒç”¨ï¼Œæ— éœ€å‡çº§æ—¶ä¸å¼¹å‡ºæç¤ºæ‰“æ‰°ç”¨æˆ·ï¼Œä»£ç å°±ä¸è´´äº†ï¼Œåªéœ€çœç•¥éƒ¨åˆ†æç¤ºä»£ç ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin>     <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>manualCheck</span>(context: Context) {
        <span style=color:#66d9ef>val</span> disposableObserver = <span style=color:#66d9ef>object</span> <span style=color:#960050;background-color:#1e0010>: </span><span style=color:#a6e22e>DisposableObserver</span>&lt;UpdateAck&gt;() {
            <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onComplete</span>() {}

            <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onNext</span>(t: UpdateAck) {
                LogUtil.d(tag, t.toString())
                <span style=color:#66d9ef>val</span> responseData = t.responseData
                <span style=color:#66d9ef>if</span> (t.result == <span style=color:#e6db74>&#34;T&#34;</span> &amp;&amp; responseData != <span style=color:#66d9ef>null</span>) {
                    <span style=color:#75715e>//æ— é”™è¯¯ä¿¡æ¯
</span><span style=color:#75715e></span>                    <span style=color:#66d9ef>if</span> (responseData.errorMessage.isBlank()) {
                        <span style=color:#75715e>//æœåŠ¡å™¨å­˜åœ¨ä¸åŒç‰ˆæœ¬
</span><span style=color:#75715e></span>                        <span style=color:#66d9ef>if</span> (responseData.isNeedUpgrade) {
                            <span style=color:#66d9ef>val</span> str = context.getString(R.string.need_upgrade)
                            <span style=color:#66d9ef>val</span> msg = String.format(str, responseData.versionName)
                            <span style=color:#66d9ef>val</span> upgradeVerName = <span style=color:#e6db74>&#34;yourAppName&#34;</span> + responseData.versionName
                            showDialog(context, msg, responseData.upgradeUrl, upgradeVerName)
                        } <span style=color:#66d9ef>else</span> {
                            <span style=color:#66d9ef>val</span> msg = context.getString(R.string.no_need_upgrade)
                            showDialog(context, msg)
                        }
                    } <span style=color:#66d9ef>else</span> {
                        showDialog(context, responseData.errorMessage)
                    }
                } <span style=color:#66d9ef>else</span> {
                    showDialog(context, t.errorMsg)
                }
            }

            <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onError</span>(e: Throwable) {
                LogUtil.e(tag, e.message.toString())
                showDialog(context, context.getString(R.string.network_state))
            }

        }
        checkUpdate(context, disposableObserver)
    }
</code></pre></div><h2 id=å‡çº§ä¿¡æ¯æç¤º>å‡çº§ä¿¡æ¯æç¤º</h2><p><code>showDialog</code>æ–¹æ³•ä¸­ä¸º<code>url</code>å’Œ<code>versionName</code>å‚æ•°è®¾ç½®äº†é»˜è®¤å€¼nullï¼Œå½“ä¸æ˜¯æç¤ºç‰ˆæœ¬æœ‰ç‰ˆæœ¬éœ€è¦æ›´æ–°æ—¶å¯ä»¥åªä¼ ä¸¤ä¸ªå‚æ•°ï¼Œè¿™æ ·èƒ½ä½¿ä»£ç çœ‹èµ·æ¥æ›´ç®€æ´ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>showDialog</span>(context: Context?, msg: String, url: String? = <span style=color:#66d9ef>null</span>, versionName: String? = <span style=color:#66d9ef>null</span>) {
        <span style=color:#75715e>//é˜²æ­¢activityé”€æ¯åå¼¹å‡ºæç¤ºå¯¼è‡´ç¨‹åºå´©æºƒ
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (context != <span style=color:#66d9ef>null</span>) {
            <span style=color:#66d9ef>val</span> builder = AlertDialog.Builder(context)
            builder.setMessage(msg)
                    .setPositiveButton(R.string.ok) { p0, _ -&gt;
                        p0.dismiss()
                        <span style=color:#75715e>//æœ‰æ–°ç‰ˆæœ¬æ—¶å¯åŠ¨æ›´æ–°æµç¨‹
</span><span style=color:#75715e></span>                        <span style=color:#66d9ef>if</span> (url != <span style=color:#66d9ef>null</span>) {
                            <span style=color:#66d9ef>if</span> (!hasDownLoad(versionName<span style=color:#f92672>!!</span>)) {
                                LogUtil.d(tag, <span style=color:#e6db74>&#34;æœªä¸‹è½½$versionName&#34;</span> + <span style=color:#e6db74>&#34;APK&#34;</span>)
                                startDownLoadService(context, url, versionName)
                            } <span style=color:#66d9ef>else</span> {
                                LogUtil.d(tag, <span style=color:#e6db74>&#34;å·²ä¸‹è½½$versionName&#34;</span> + <span style=color:#e6db74>&#34;APK&#34;</span>)
                                installAPK(context, versionName)
                            }
                        }
                    }
                    .setNegativeButton(R.string.cancel) { p0, _ -&gt;
                        p0.dismiss()
                    }.create().show()
            <span style=color:#75715e>//é€šè¿‡EventBusé€šçŸ¥AppInfoé¡µé¢éšè—ç½‘ç»œè¯·æ±‚çš„æ—‹è½¬èŠèŠ±
</span><span style=color:#75715e></span>            EventBus.getDefault().post(EventMsg.AppInfoDismissProgressBar())
        }
    }
</code></pre></div><p>å¦‚æœå½“å‰ç‰ˆæœ¬å’ŒæœåŠ¡å™¨ä¸Šçš„ç‰ˆæœ¬ä¸ä¸€è‡´æ—¶ï¼Œå…ˆè°ƒç”¨<code>hasDownload(versionName!!)</code>æ–¹æ³•æ£€æŸ¥æŒ‡å®šè·¯å¾„æ˜¯å¦å­˜åœ¨æœ€æ–°çš„APKæ–‡ä»¶</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>hasDownLoad</span>(versionName: String): Boolean {
        <span style=color:#66d9ef>return</span> apkFile(versionName).exists()
    }
    
<span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>apkFile</span>(versionName: String): File {
        <span style=color:#66d9ef>return</span> File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS).absolutePath + <span style=color:#e6db74>&#34;/&#34;</span> + versionName + <span style=color:#e6db74>&#34;.apk&#34;</span>)
    }
</code></pre></div><p>å¦‚æœå­˜åœ¨åˆ™ç›´æ¥è¿›è¡Œå®‰è£…ï¼Œå¦‚æœæ²¡æœ‰æœ€æ–°ç‰ˆçš„APKæ–‡ä»¶ï¼Œåˆ™é€šè¿‡ <code>startDownLoadService(context, url, versionName)</code>æ¥å¼€å¯UpgradeServiceè¿›è¡Œåå°ä¸‹è½½ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>startDownLoadService</span>(context: Context, url: String, versionName: String) {
        <span style=color:#66d9ef>val</span> intent = Intent(context, UpgradeService<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java)
        intent.putExtra(<span style=color:#e6db74>&#34;url&#34;</span>, url)
        intent.putExtra(<span style=color:#e6db74>&#34;versionName&#34;</span>, versionName)
        context.startService(intent)
    }
</code></pre></div><h2 id=å®‰è£…apk>å®‰è£…APK</h2><p>å®‰è£…ä»£ç :</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>installAPK</span>(context: Context, versionName: String) {
        <span style=color:#66d9ef>val</span> install = installIntent(context, versionName)
        context.startActivity(install)
    }

  <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>installIntent</span>(context: Context, versionName: String): Intent {
        <span style=color:#66d9ef>val</span> file = apkFile(versionName)
        <span style=color:#75715e>//7.0å…³äºè¯»å†™æ–‡ä»¶æœ‰æ›´ä¸¥æ ¼çš„è¦æ±‚ï¼Œéœ€è¦é…ç½®FileProvider
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>val</span> uri = <span style=color:#66d9ef>if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) {
            FileProvider.getUriForFile(context, <span style=color:#e6db74>&#34;com.xxxxx.fileprovider&#34;</span>, file)
        } <span style=color:#66d9ef>else</span> {
            Uri.fromFile(file)
        }
        <span style=color:#66d9ef>val</span> install = Intent(Intent.ACTION_VIEW)
        install.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)<span style=color:#75715e>//ä¸º7.0æ·»åŠ 
</span><span style=color:#75715e></span>        install.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
        install.setDataAndType(uri, <span style=color:#e6db74>&#34;application/vnd.android.package-archive&#34;</span>)
        <span style=color:#66d9ef>return</span> install
    }
</code></pre></div><h2 id=åˆ é™¤å†—ä½™apkæ–‡ä»¶>åˆ é™¤å†—ä½™APKæ–‡ä»¶</h2><p>åœ¨å¯åŠ¨é¡µé¢è°ƒç”¨ <code>UpgradeManager.cleanOldApk(ctx)</code>æ£€æŸ¥å½“å‰è¿è¡Œçš„APPç‰ˆæœ¬å’ŒæŒ‡å®šè·¯å¾„çš„APK <code>versionName</code>æ˜¯å¦ç›¸åŒï¼Œç›¸åŒåˆ™åˆ é™¤</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>cleanOldApk</span>(context: Context) {
        <span style=color:#66d9ef>val</span> pm = context.packageManager
        <span style=color:#66d9ef>val</span> locVersionName = pm.getPackageInfo(context.applicationInfo.packageName, <span style=color:#ae81ff>0</span>).versionName
        <span style=color:#75715e>//å·²ä¸‹è½½çš„APKå’Œå½“å‰å®‰è£…çš„ç‰ˆæœ¬ç›¸åŒ,åˆ é™¤ä¸‹è½½çš„APK
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (hasDownLoad(<span style=color:#e6db74>&#34;yourAppName$locVersionName&#34;</span>)) {
            apkFile(<span style=color:#e6db74>&#34;yourAppName$locVersionName&#34;</span>).delete()
        }
    }
</code></pre></div><h1 id=upgradeservice>UpgradeService</h1><p>è¯¥ç±»ä¸»è¦å®ç°</p><ul><li>APK<code>ä¸‹è½½</code> <code>ä¿å­˜</code> <code>å®‰è£…</code></li><li>é€šçŸ¥ä¸­å¿ƒæ›´æ–°ä¸‹è½½è¿›åº¦</li></ul><h2 id=oncreate>onCreate</h2><p><strong>åˆå§‹åŒ–å‡çº§æœåŠ¡</strong></p><ol><li>æ³¨å†ŒEventBuså¹¶å‘é€ç²˜æ€§å¹¿æ’­æç¤ºå‡çº§æœåŠ¡å·²å¯åŠ¨</li><li>åˆå§‹åŒ–é€šçŸ¥ä¸­å¿ƒå¯¹è±¡ï¼Œè®¾ç½®æ ‡é¢˜ï¼Œä¿¡æ¯ï¼Œå›¾æ ‡</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onCreate</span>() {
        <span style=color:#66d9ef>super</span>.onCreate()
        LogUtil.d(tag, <span style=color:#e6db74>&#34;onCreate&#34;</span>)
        EventBus.getDefault().register(<span style=color:#66d9ef>this</span>)
        EventBus.getDefault().postSticky(EventMsg.UpgradeServiceState(<span style=color:#66d9ef>true</span>))
        notificationManager = getSystemService(Context.NOTIFICATION_SERVICE) <span style=color:#66d9ef>as</span> NotificationManager
        notificationBuilder = NotificationCompat.Builder(<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>&#34;upgrade&#34;</span>)
        notificationBuilder.setContentTitle(getString(R.string.notification_upgrade_title))
                .setContentText(getString(R.string.notification_loading))
                .setSmallIcon(R.mipmap.mainlancher)
        notificationBuilder.priority = PRIORITY_HIGH
        <span style=color:#75715e>//ç‚¹å‡»åè‡ªåŠ¨ç§»é™¤é€šçŸ¥
</span><span style=color:#75715e></span>        notificationBuilder.setAutoCancel(<span style=color:#66d9ef>true</span>)
    }
</code></pre></div><h2 id=onstartcommand>onStartCommand</h2><p><strong>å¼€å§‹ä¸‹è½½</strong>
é€šè¿‡<code>isDowloading</code>å’Œ<code>needDownLoad</code>åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡Œä¸‹è½½æ“ä½œ</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onStartCommand</span>(intent: Intent, flags: Int, startId: Int): Int {
        LogUtil.d(tag, <span style=color:#e6db74>&#34;onStartCommandï¼šstartId$startId&#34;</span>)
        url = intent.getStringExtra(<span style=color:#e6db74>&#34;url&#34;</span>)
        versionName = intent.getStringExtra(<span style=color:#e6db74>&#34;versionName&#34;</span>)
        <span style=color:#66d9ef>val</span> needDownLoad = !UpgradeManager.hasDownLoad(versionName)
        <span style=color:#66d9ef>if</span> (!isDowloading &amp;&amp; needDownLoad) {
            retryCount = <span style=color:#ae81ff>0</span>
            downLoadAPK()
        } <span style=color:#66d9ef>else</span> {
            LogUtil.d(tag, <span style=color:#e6db74>&#34;å·²æœ‰ä¸‹è½½ä»»åŠ¡åœ¨æ‰§è¡Œï¼ï¼ï¼ï¼&#34;</span>)
        }
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.onStartCommand(intent, flags, startId)
    }
</code></pre></div><h2 id=apkä¸‹è½½å¹¶ä¿å­˜å¹¶å®‰è£…>APKä¸‹è½½å¹¶ä¿å­˜å¹¶å®‰è£…</h2><h3 id=downloadapk>downLoadAPK</h3><p><code>retryCount</code>é‡è¯•æ¬¡æ•°ï¼Œç›®å‰è®¾ç½®çš„é‡è¯•æ¬¡æ•°ä¸º7æ¬¡ã€‚
ä¸‹è½½å¼€å§‹åå°†<code>isDowloading</code>ç½®ä¸º<code>true</code>
è¯·æ±‚æˆåŠŸåè°ƒç”¨<code>saveFile(fileResponseBody: ResponseBody)</code>è¯»å–æ•°æ®å†™å…¥æœ¬åœ°</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin> <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>downLoadAPK</span>() {
        <span style=color:#75715e>//ä¸‹è½½æ¬¡æ•°
</span><span style=color:#75715e></span>        retryCount++
        LogUtil.d(tag, <span style=color:#e6db74>&#34;å¼€å§‹ä¸‹è½½&#34;</span>)
        RetrofitClient.removeMethod(<span style=color:#e6db74>&#34;downloadAPK&#34;</span>)
        <span style=color:#66d9ef>val</span> downLoadCall = RetrofitClient.apiService.getApk(url)
                .subscribeOn(Schedulers.io())
                .observeOn(Schedulers.io())
                .subscribeWith(<span style=color:#66d9ef>object</span> <span style=color:#960050;background-color:#1e0010>: </span><span style=color:#a6e22e>DisposableObserver</span>&lt;ResponseBody&gt;() {
                    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onStart</span>() {
                        isDowloading = <span style=color:#66d9ef>true</span>
                    }

                    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onComplete</span>() {
                        LogUtil.d(tag, <span style=color:#e6db74>&#34;onComplete&#34;</span>)
                    }

                    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onNext</span>(t: ResponseBody) {
                        LogUtil.d(tag, <span style=color:#e6db74>&#34;onNext&#34;</span>)
                        saveFile(t)
                    }

                    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onError</span>(e: Throwable) {
                        isDowloading = <span style=color:#66d9ef>false</span>
                        LogUtil.e(tag, e.message.toString())
                    }

                })

        RetrofitClient.addMethod(javaClass.name, <span style=color:#e6db74>&#34;downloadAPK&#34;</span>, downLoadCall)
    }
</code></pre></div><h3 id=savefile>saveFile</h3><p>å†™å…¥æ–‡ä»¶åˆ°æœ¬åœ°<code>Download</code>å…¬å…±æ–‡ä»¶å¤¹
<strong>æœŸé—´è‹¥å‘ç”Ÿé”™è¯¯</strong></p><ol><li>é€šè¿‡<code>UpgradeManager.apkFile(versionName).delete()</code>æ¸…é™¤æœªä¸‹è½½å®Œçš„æ–‡ä»¶</li><li>é€šè¿‡<code> updateNotification(R.string.notification_err_retry)</code>æ›´æ–°é€šçŸ¥ä¸­å¿ƒæç¤º</li><li>é€šè¿‡<code>retryCount</code>åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•ï¼Œè¶…è¿‡é‡è¯•ä¸Šé™åˆ™æ›´æ–°é€šçŸ¥ä¸­å¿ƒå¹¶è°ƒç”¨<code>stopSelf()</code>åœæ­¢æœåŠ¡</li></ol><p><strong>é¡ºåˆ©ä¿å­˜åˆ°æœ¬åœ°</strong>åˆ™è°ƒç”¨<code>installAPK()</code>å®‰è£…APKï¼Œå¹¶å°†<code>isDowloading</code>ç½®ä¸º<code>false</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>saveFile</span>(fileResponseBody: ResponseBody) {
        Observable.create&lt;File&gt; { e -&gt;
            <span style=color:#66d9ef>var</span> inputStream: InputStream? = <span style=color:#66d9ef>null</span>
            <span style=color:#66d9ef>var</span> fileOutputStream: FileOutputStream? = <span style=color:#66d9ef>null</span>
            <span style=color:#66d9ef>val</span> buffer = ByteArray(<span style=color:#ae81ff>2048</span>)
            <span style=color:#66d9ef>val</span> apkFile = UpgradeManager.apkFile(versionName)
            LogUtil.d(tag, <span style=color:#e6db74>&#34;ä¿å­˜æ–‡ä»¶åˆ°&#34;</span> + apkFile.absolutePath)
            <span style=color:#66d9ef>try</span> {
                inputStream = fileResponseBody.byteStream()
                fileOutputStream = FileOutputStream(apkFile)
                <span style=color:#66d9ef>var</span> len = inputStream<span style=color:#f92672>!!</span>.read(buffer)
                <span style=color:#66d9ef>while</span> (len != -<span style=color:#ae81ff>1</span>) {
                    fileOutputStream.write(buffer, <span style=color:#ae81ff>0</span>, len)
                    len = inputStream.read(buffer)
                }
                fileOutputStream.flush()
                e.onNext(apkFile)
            } <span style=color:#66d9ef>catch</span> (err: IOException) {
                e.onError(err)
            } <span style=color:#66d9ef>finally</span> {
                inputStream<span style=color:#f92672>?.</span>close()
                fileOutputStream<span style=color:#f92672>?.</span>close()
                e.onComplete()
            }
        }.subscribeOn(Schedulers.io())
                .observeOn(Schedulers.io())
                .subscribe({
                    isDowloading = <span style=color:#66d9ef>false</span>
                    installAPK()
                }, { e -&gt;
                    isDowloading = <span style=color:#66d9ef>false</span>
                    LogUtil.e(tag, e.message.toString())
                    UpgradeManager.apkFile(versionName).delete()
                    updateNotification(R.string.notification_err_retry)
                    <span style=color:#66d9ef>if</span> (retryCount &lt; <span style=color:#ae81ff>7</span>) {
                        downLoadAPK()
                    } <span style=color:#66d9ef>else</span> {
                        updateNotification(R.string.notification_err_retry_later)
                        stopSelf()
                    }
                })
    }
</code></pre></div><p><strong>updateNotification(resId: Int)</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin> <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>updateNotification</span>(resId: Int) {
        <span style=color:#66d9ef>val</span> string = getString(resId)
        notificationBuilder.setContentText(string)
        notificationManager.notify(<span style=color:#ae81ff>0</span>, notificationBuilder.build())
    }
</code></pre></div><h3 id=installapk>installAPK</h3><ol><li>é€šè¿‡<code>notificationBuilder.setProgress(0, 0, false)</code>ç§»é™¤é€šçŸ¥ä¸­çš„ä¸‹è½½è¿›åº¦æ¡</li><li>é€šè¿‡<code>notificationBuilder.setContentIntent(pendingIntent)</code>è®¾ç½®é€šçŸ¥çš„ç‚¹å‡»å“åº”ï¼Œä»¥ä¾¿ç”¨æˆ·åœ¨å®‰è£…ç•Œé¢ç‚¹å‡»äº†<code>å–æ¶ˆ</code>è¿˜èƒ½é€šè¿‡ç‚¹å‡»é€šçŸ¥è¿›è¡Œå®‰è£…</li><li>é€šè¿‡<code> updateNotification(R.string.notification_load_complete)</code>æ›´æ–°é€šçŸ¥ä¸­å¿ƒæç¤º</li><li>æ‰§è¡Œå®‰è£…</li><li>é€šè¿‡<code>stopSelf()</code>åœæ­¢æœåŠ¡</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin> <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>installAPK</span>() {
        notificationBuilder.setProgress(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>false</span>)
        <span style=color:#66d9ef>val</span> install = UpgradeManager.installIntent(applicationContext, versionName)
        <span style=color:#66d9ef>val</span> pendingIntent = PendingIntent.getActivity(<span style=color:#66d9ef>this</span>, <span style=color:#ae81ff>0</span>, install, PendingIntent.FLAG_UPDATE_CURRENT)
        notificationBuilder.setContentIntent(pendingIntent)
        updateNotification(R.string.notification_load_complete)
        startActivity(install)
        stopSelf()
    }
</code></pre></div><h2 id=ondestroy>onDestroy</h2><ol><li>åœæ­¢æ‰€æœ‰å½“å‰ç±»åç›¸å…³ç½‘ç»œè¯·æ±‚</li><li>å‘é€ç²˜æ€§å¹¿æ’­é€šçŸ¥æ›´æ–°æœåŠ¡å·²åœæ­¢</li><li>æ³¨é”€<code>EventBus</code></li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onDestroy</span>() {
        <span style=color:#66d9ef>super</span>.onDestroy()
        LogUtil.d(tag, <span style=color:#e6db74>&#34;onDestroy&#34;</span>)
        RetrofitClient.removeAll(javaClass.name)
        EventBus.getDefault().postSticky(EventMsg.UpgradeServiceState(<span style=color:#66d9ef>false</span>))
        EventBus.getDefault().unregister(<span style=color:#66d9ef>this</span>)
    }
</code></pre></div><h2 id=ä¸‹è½½è¿›åº¦ç™¾åˆ†æ¯”>ä¸‹è½½è¿›åº¦ç™¾åˆ†æ¯”</h2><p>ä¸‹è½½è¿›åº¦æ›´æ–°é€šè¿‡<code>EventBus</code>+<code>ResponseInterceptor</code>+<code>FileResponseBody</code>å®ç°</p><ol><li>è‡ªå®šä¹‰<code>ResponseBody</code>å³ä¸‹æ–‡çš„<code>FileResponseBody</code>ï¼Œé‡å†™<code>ResponseBody</code>çš„<code>fun source()</code>æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•å†…è·å–å½“å‰ä¸‹è½½è¿›åº¦å¹¶é€šè¿‡<code>EventBus</code>å¹¿æ’­</li><li>è‡ªå®šä¹‰<code>Interceptor</code>å³ä¸‹æ–‡çš„<code>ResponseInterceptor</code>ï¼Œå°†åŸ<code>ResponseBody</code>æ›¿æ¢ä¸º<code>FileResponseBody</code>ä»¥è·å–ä¸‹è½½è¿›åº¦</li><li>åœ¨åˆ›å»º<code>OkHttpClient</code>çš„è¿‡ç¨‹ä¸­é€šè¿‡<code>addNetworkInterceptor(ResponseInterceptor())</code>å°†è‡ªå®šä¹‰ç½‘ç»œæ‹¦æˆªå™¨æ·»åŠ è¿›å»</li><li>åœ¨<code>UpgradeService</code>æ¥æ”¶ä¸‹è½½è¿›åº¦å¹¶æ›´æ–°åˆ°é€šçŸ¥ä¸­å¿ƒ</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin>    @Subscribe(threadMode = ThreadMode.BACKGROUND)
    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>downloadProgress</span>(event: EventMsg.FileLoading) {
        <span style=color:#66d9ef>val</span> progress = (event.bytesRead / event.contentLength) * <span style=color:#ae81ff>100</span>
        <span style=color:#66d9ef>val</span> progressStr = String.format(<span style=color:#e6db74>&#34;%.2f&#34;</span>, progress)
        <span style=color:#75715e>//ä»¥1%ä¸ºæ­¥è¿›ï¼Œå¤§é‡æ›´æ–°ä¼šå¯¼è‡´é€šçŸ¥ä¸­å¿ƒä¸‹æ‹‰å¡æ­»
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (progressStr.endsWith(<span style=color:#e6db74>&#34;00&#34;</span>)) {
            notificationBuilder.setProgress(<span style=color:#ae81ff>100</span>, progress.toInt(), <span style=color:#66d9ef>false</span>)
            notificationManager.notify(<span style=color:#ae81ff>0</span>, notificationBuilder.build())
        }
    }
</code></pre></div><h1 id=fileresponsebody>FileResponseBody</h1><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FileResponseBody</span>(<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> originalResponse: Response) : ResponseBody() {

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>var</span> bufferedSource: BufferedSource? = <span style=color:#66d9ef>null</span>

    init {
        LogUtil.d(<span style=color:#e6db74>&#34;FileResponseBody init&#34;</span>)
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>contentType</span>(): MediaType? {
        <span style=color:#66d9ef>return</span> originalResponse.body()<span style=color:#f92672>?.</span>contentType()
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>contentLength</span>(): Long {<span style=color:#75715e>// è¿”å›æ–‡ä»¶çš„æ€»é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¿›åº¦æ¡çš„max
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> originalResponse.body()<span style=color:#f92672>!!</span>.contentLength()
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>source</span>(): BufferedSource {
        <span style=color:#66d9ef>if</span> (bufferedSource == <span style=color:#66d9ef>null</span>) {
            bufferedSource = Okio.buffer(source(originalResponse.body()<span style=color:#f92672>!!</span>.source()))
        }
        <span style=color:#66d9ef>return</span> bufferedSource<span style=color:#f92672>!!</span>
    }

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>source</span>(source: Source): Source {
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>object</span> <span style=color:#960050;background-color:#1e0010>: </span><span style=color:#a6e22e>ForwardingSource</span>(source) {
            <span style=color:#66d9ef>var</span> totalBytesRead = <span style=color:#ae81ff>0L</span>
            <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>read</span>(sink: Buffer, byteCount: Long): Long {
                <span style=color:#66d9ef>val</span> bytesRead = <span style=color:#66d9ef>super</span>.read(sink, byteCount)
                <span style=color:#75715e>// read() returns the number of bytes read, or -1 if this source is exhausted.
</span><span style=color:#75715e></span>                totalBytesRead += <span style=color:#66d9ef>if</span> (bytesRead == -<span style=color:#ae81ff>1L</span>) <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>else</span> bytesRead
                LogUtil.d(<span style=color:#e6db74>&#34;readed:&#34;</span>, totalBytesRead.toString())
                EventBus.getDefault().post(EventMsg.FileLoading(contentLength().toFloat(), totalBytesRead.toFloat()))
                <span style=color:#66d9ef>return</span> bytesRead
            }
        }
    }

}
</code></pre></div><h1 id=responseinterceptor>ResponseInterceptor</h1><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin> <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ResponseInterceptor</span> : Interceptor {
        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>intercept</span>(chain: Interceptor.Chain): Response {
            <span style=color:#66d9ef>val</span> request = chain.request()
            LogUtil.d(<span style=color:#e6db74>&#34;request.url&#34;</span>, request.url().toString())
            <span style=color:#75715e>//åœ°å€ä¸ºä¸‹è½½APKçš„åœ°å€æ—¶æ›¿æ¢ä¸ºFileResponseBody
</span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> (request.url().toString().startsWith(<span style=color:#e6db74>&#34;http://www.******.com&#34;</span>)) {
                LogUtil.d(<span style=color:#e6db74>&#34;new Response&#34;</span>)
                <span style=color:#66d9ef>val</span> response = chain.proceed(request)
                <span style=color:#66d9ef>return</span> response.newBuilder().body(FileResponseBody(response)).build()
            }
            <span style=color:#66d9ef>return</span> chain.proceed(request)
        }
    }
</code></pre></div></section><footer class=article-footer><section class=article-tags><a href=/tags/android>Android</a>
<a href=/tags/kotlin>Kotlin</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licenced under CC BY-NC-SA 4.0</span></section></footer></article><aside class="widget related-contents--wrapper"></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"hugo-theme-stack"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--content-padding)}</style><footer class=site-footer><section class=copyright>&copy; 2020 3702</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank>Stack</a></b> designed by
<a href=https://jimmycai.com target=_blank>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true style=display:none><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const customFont=document.createElement('link');customFont.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";customFont.type="text/css";customFont.rel="stylesheet";document.head.appendChild(customFont);}());</script></body></html>